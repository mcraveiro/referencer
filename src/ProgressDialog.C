

#include "ProgressDialog.h"

#include <libgnomemm/main.h>

#include <iostream>

ProgressDialog::ProgressDialog ()
{
	dialog_ = new Gtk::Dialog ();
	dialog_->set_modal (true);
	dialog_->set_has_separator (false);

	Gtk::VBox *vbox = dialog_->get_vbox ();
	vbox->set_spacing (12);

	progress_ = Gtk::manage (new Gtk::ProgressBar);
	label_ = Gtk::manage (new Gtk::Label ("", false));

	vbox->pack_start (*label_, true, true, 0);
	vbox->pack_start (*progress_, false, false, 0);
}


ProgressDialog::~ProgressDialog ()
{
	if (!finished_)
		finish ();
	delete dialog_;
}


void ProgressDialog::setLabel (Glib::ustring const &markup)
{
	label_->set_markup (markup);
}


void ProgressDialog::start ()
{
	dialog_->show_all ();
	// Make sure it's realised before setting the border width
	// There should (must be) be a better way...
	/*while (Gnome::Main::events_pending())
		Gnome::Main::iteration ();
	dialog_->get_vbox ()->set_border_width (12);*/

	// Flag that the loop thread waits for
	finished_ = false;

	// Spawn the loop thread
	loopthread_ = Glib::Thread::create (
		sigc::mem_fun (this, &ProgressDialog::loop), true);
}


void ProgressDialog::finish ()
{
	finished_ = true;
	loopthread_->join ();
}


void ProgressDialog::update (double status)
{
	progress_->set_fraction (status);
}


void ProgressDialog::update ()
{
	progress_->pulse ();
}


void ProgressDialog::loop ()
{
	// Is this conflicting with Gnome::Ui::Thumbnailfactory in Document::setupThumbnail?  Do we need a mutex?
	while (!finished_) {
		getLock ();
		while (Gnome::Main::events_pending())
			Gnome::Main::iteration ();
		releaseLock ();
		Glib::usleep (100000);
	}
}


void ProgressDialog::getLock ()
{
	lock_.lock ();
}


void ProgressDialog::releaseLock ()
{
	lock_.unlock ();
}


